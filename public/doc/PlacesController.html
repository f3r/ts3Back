<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>Class: PlacesController</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/controllers/places_controller.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="ApplicationController.html">ApplicationController</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-check_availability">#check_availability</a>
    
    <li><a href="#method-i-create">#create</a>
    
    <li><a href="#method-i-destroy">#destroy</a>
    
    <li><a href="#method-i-place_request">#place_request</a>
    
    <li><a href="#method-i-publish">#publish</a>
    
    <li><a href="#method-i-search">#search</a>
    
    <li><a href="#method-i-show">#show</a>
    
    <li><a href="#method-i-transactions">#transactions</a>
    
    <li><a href="#method-i-update">#update</a>
    
    <li><a href="#method-i-user_places">#user_places</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AddressesController.html">AddressesController</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./AuthenticationsController.html">AuthenticationsController</a>
  
    <li><a href="./AvailabilitiesController.html">AvailabilitiesController</a>
  
    <li><a href="./CommentsController.html">CommentsController</a>
  
    <li><a href="./ConfirmationsController.html">ConfirmationsController</a>
  
    <li><a href="./GeoController.html">GeoController</a>
  
    <li><a href="./HomeController.html">HomeController</a>
  
    <li><a href="./MessagesController.html">MessagesController</a>
  
    <li><a href="./NotificationsController.html">NotificationsController</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PasswordsController.html">PasswordsController</a>
  
    <li><a href="./PlaceTypesController.html">PlaceTypesController</a>
  
    <li><a href="./PlacesController.html">PlacesController</a>
  
    <li><a href="./RegistrationsController.html">RegistrationsController</a>
  
    <li><a href="./SessionsController.html">SessionsController</a>
  
    <li><a href="./TransactionsController.html">TransactionsController</a>
  
    <li><a href="./UsersController.html">UsersController</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class PlacesController</h1>

  <div id="description" class="description">
    
  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 9</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>
  <span class="ruby-ivar">@fields</span> = [
    <span class="ruby-value">:id</span>, <span class="ruby-value">:title</span>, <span class="ruby-value">:description</span>, <span class="ruby-value">:num_bedrooms</span>, <span class="ruby-value">:num_beds</span>, 
    <span class="ruby-value">:num_bathrooms</span>, <span class="ruby-value">:size</span>, <span class="ruby-value">:size_sqm</span>, <span class="ruby-value">:size_sqf</span>, <span class="ruby-value">:size_unit</span>, <span class="ruby-value">:max_guests</span>, <span class="ruby-value">:photos</span>, <span class="ruby-value">:city_id</span>, <span class="ruby-value">:address_1</span>, 
    <span class="ruby-value">:address_2</span>, <span class="ruby-value">:zip</span>, <span class="ruby-value">:lat</span>, <span class="ruby-value">:lon</span>, <span class="ruby-value">:directions</span>, 
    <span class="ruby-value">:check_in_after</span>, <span class="ruby-value">:check_out_before</span>, <span class="ruby-value">:minimum_stay_days</span>, 
    <span class="ruby-value">:maximum_stay_days</span>, <span class="ruby-value">:house_rules</span>, <span class="ruby-value">:cancellation_policy</span>,
    <span class="ruby-value">:reviews_overall</span>,<span class="ruby-value">:reviews_accuracy_avg</span>,<span class="ruby-value">:reviews_cleanliness_avg</span>,
    <span class="ruby-value">:reviews_checkin_avg</span>,<span class="ruby-value">:reviews_communication_avg</span>,<span class="ruby-value">:reviews_location_avg</span>,
    <span class="ruby-value">:reviews_value_avg</span>, <span class="ruby-value">:currency</span>, <span class="ruby-value">:price_final_cleanup</span>, 
    <span class="ruby-value">:price_security_deposit</span>, <span class="ruby-value">:price_per_night</span>, <span class="ruby-value">:price_per_week</span>, <span class="ruby-value">:price_per_month</span>,
    <span class="ruby-value">:published</span>,
    <span class="ruby-value">:country_name</span>, <span class="ruby-value">:country_code</span>, <span class="ruby-value">:state_name</span>, <span class="ruby-value">:city_name</span>,
    <span class="ruby-value">:price_final_cleanup_usd</span>, <span class="ruby-value">:price_security_deposit_usd</span>, <span class="ruby-value">:price_per_night_usd</span>, <span class="ruby-value">:price_per_week_usd</span>, <span class="ruby-value">:price_per_month_usd</span>
  ]
  
  <span class="ruby-ivar">@amenities</span> = [
    <span class="ruby-value">:amenities_aircon</span>,<span class="ruby-value">:amenities_breakfast</span>,<span class="ruby-value">:amenities_buzzer_intercom</span>,<span class="ruby-value">:amenities_cable_tv</span>,
    <span class="ruby-value">:amenities_dryer</span>,<span class="ruby-value">:amenities_doorman</span>,<span class="ruby-value">:amenities_elevator</span>,
    <span class="ruby-value">:amenities_family_friendly</span>,<span class="ruby-value">:amenities_gym</span>,<span class="ruby-value">:amenities_hot_tub</span>,<span class="ruby-value">:amenities_kitchen</span>,
    <span class="ruby-value">:amenities_handicap</span>,<span class="ruby-value">:amenities_heating</span>,<span class="ruby-value">:amenities_hot_water</span>,
    <span class="ruby-value">:amenities_internet</span>,<span class="ruby-value">:amenities_internet_wifi</span>,<span class="ruby-value">:amenities_jacuzzi</span>,<span class="ruby-value">:amenities_parking_included</span>,
    <span class="ruby-value">:amenities_pets_allowed</span>,<span class="ruby-value">:amenities_pool</span>,<span class="ruby-value">:amenities_smoking_allowed</span>,<span class="ruby-value">:amenities_suitable_events</span>,
    <span class="ruby-value">:amenities_tennis</span>,<span class="ruby-value">:amenities_tv</span>,<span class="ruby-value">:amenities_washer</span>  
  ]
  
  <span class="ruby-ivar">@search_fields</span> = [
    <span class="ruby-value">:id</span>, <span class="ruby-value">:title</span>, <span class="ruby-value">:size_sqf</span>, <span class="ruby-value">:size_sqm</span>, <span class="ruby-value">:reviews_overall</span>, <span class="ruby-value">:price_per_night_usd</span>, <span class="ruby-value">:price_per_week_usd</span>, <span class="ruby-value">:price_per_month_usd</span>, <span class="ruby-value">:photos</span>,
    <span class="ruby-value">:price_per_night</span>, <span class="ruby-value">:price_per_week</span>, <span class="ruby-value">:price_per_month</span>, <span class="ruby-value">:currency</span>
  ]

  <span class="ruby-ivar">@fields</span> = <span class="ruby-ivar">@fields</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@amenities</span>

  <span class="ruby-comment"># Associations</span>
  <span class="ruby-ivar">@user_fields</span> = [<span class="ruby-value">:id</span>, <span class="ruby-value">:first_name</span>, <span class="ruby-value">:last_name</span>, <span class="ruby-value">:avatar_file_name</span>, <span class="ruby-value">:role</span>]
  <span class="ruby-ivar">@place_type_fields</span> = [<span class="ruby-value">:id</span>,<span class="ruby-value">:name</span>]

  <span class="ruby-ivar">@transaction_fields</span> = [
    <span class="ruby-value">:id</span>, <span class="ruby-value">:state</span>, <span class="ruby-value">:check_in</span>, <span class="ruby-value">:check_out</span>, <span class="ruby-value">:transaction_code</span>,
    <span class="ruby-value">:currency</span>, <span class="ruby-value">:price_per_night</span>, <span class="ruby-value">:price_final_cleanup</span>, <span class="ruby-value">:price_security_deposit</span>, <span class="ruby-value">:service_fee</span>, <span class="ruby-value">:service_percentage</span>, <span class="ruby-value">:sub_total</span>
  ]
  
  <span class="ruby-ivar">@place_details</span> = [
    <span class="ruby-value">:title</span>
  ]

<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-check_availability" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">check_availability</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-check_availability-label-Description">Description</h2>

<p>Checks place availability</p>

<h2 id="method-i-check_availability-label-Resource+URL">Resource URL</h2>

<pre>/places/:id/check_availability.format</pre>

<h2 id="method-i-check_availability-label-Example">Example</h2>

<pre>GET https://backend-heypal.heroku.com/places/:id/check_availability.json access_token=access_token&amp;check_in=2011/12/01&amp;check_out=2012/01/03</pre>

<h3 id="method-i-check_availability-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd>
<p>Access token</p>
</dd><dt>check_in
<dd>
<p>Check in date</p>
</dd><dt>check_out
<dd>
<p>Check out date</p>
</dd><dt>currency
<dd>
<p>ISO Code of the currency to return prices in</p>
</dd></dl>

<h3 id="method-i-check_availability-label-Response">Response</h3>
<dl class="rdoc-list label-list"><dt>dates
<dd>
<p>Array containing the selected dates, with their respective price_per_night
and comment if present</p>
</dd><dt>total_days
<dd>
<p>total nights selected</p>
</dd><dt>currency
<dd></dd><dt>avg_price_per_night
<dd>
<p>Average price_per_night, depending on availabilities special prices</p>
</dd><dt>price_security_deposit
<dd></dd><dt>price_final_cleanup
<dd></dd><dt>sub_total
<dd>
<p>sum of price_per_night</p>
</dd></dl>

<h3 id="method-i-check_availability-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>106
<dd>
<p>Record not found</p>
</dd><dt>113
<dd>
<p>Invalid date</p>
</dd><dt>119
<dd>
<p>date must be future, after today</p>
</dd><dt>120
<dd>
<p>end date must be after initial date</p>
</dd></dl>
          

          
          <div class="method-source-code" id="check_availability-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 473</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">check_availability</span>
  <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-identifier">place_availability</span> = <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">place_availability</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:check_in</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:check_out</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>], <span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">place_availability</span>[<span class="ruby-value">:err</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, <span class="ruby-identifier">place_availability</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:fail</span>, <span class="ruby-identifier">place_availability</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- check_availability-source -->
          
        </div>

        

        
      </div><!-- check_availability-method -->

    
      <div id="method-i-create" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-create-label-Description">Description</h2>

<p>Crates a new place with basic information</p>

<h2 id="method-i-create-label-Resource+URL">Resource URL</h2>

<pre>/places.format</pre>

<h2 id="method-i-create-label-Example">Example</h2>

<pre>POST https://backend-heypal.heroku.com/places.json access_token=access_token&amp;title=Joe's Apartment&amp;type_id=2&amp;num_bedrooms=3&amp;max_guests=5&amp;city_id=62</pre>

<h3 id="method-i-create-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd>
<p>Access token</p>
</dd><dt>title
<dd>
<p>Title for the place</p>
</dd><dt>place_type_id
<dd>
<p>ID from the PlaceType model, Integer</p>
</dd><dt>num_bedrooms
<dd>
<p>Integer</p>
</dd><dt>max_guests
<dd>
<p>Integer</p>
</dd><dt>city_id
<dd>
<p>ID from the City model, Integer</p>
</dd><dt>currency
<dd>
<p>Currency</p>
</dd></dl>

<h3 id="method-i-create-label-Response">Response</h3>
<dl class="rdoc-list label-list"><dt>place
<dd>
<p>Array containing the recently created place</p>
</dd></dl>

<h3 id="method-i-create-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>101
<dd>
<p>can’t be blank</p>
</dd><dt>103
<dd>
<p>is invalid</p>
</dd><dt>105
<dd>
<p>invalid access token</p>
</dd><dt>132
<dd>
<p>invalid city (not on the cities table)</p>
</dd></dl>
          

          
          <div class="method-source-code" id="create-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 285</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
  <span class="ruby-identifier">place</span> = { 
    <span class="ruby-value">:title</span>         =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:title</span>],
    <span class="ruby-value">:place_type_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:place_type_id</span>],
    <span class="ruby-value">:num_bedrooms</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:num_bedrooms</span>],
    <span class="ruby-value">:max_guests</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:max_guests</span>],
    <span class="ruby-value">:city_id</span>       =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:city_id</span>],
    <span class="ruby-value">:currency</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>]}
  <span class="ruby-ivar">@place</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">places</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">place</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-identifier">place_return</span> = <span class="ruby-identifier">filter_fields</span>(<span class="ruby-ivar">@place</span>, [<span class="ruby-value">:id</span>, <span class="ruby-value">:title</span>,<span class="ruby-value">:num_bedrooms</span>,<span class="ruby-value">:max_guests</span>,<span class="ruby-value">:country_name</span>, <span class="ruby-value">:country_code</span>, <span class="ruby-value">:state_name</span>, <span class="ruby-value">:city_name</span>, <span class="ruby-value">:city_id</span>, <span class="ruby-value">:currency</span>], <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> {
        <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user_fields</span>,
        <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@place_type_fields</span>
      })
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, {<span class="ruby-value">:place</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">place_return</span>})
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:fail</span>, {<span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">format_errors</span>(<span class="ruby-ivar">@place</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">messages</span>)})
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- create-source -->
          
        </div>

        

        
      </div><!-- create-method -->

    
      <div id="method-i-destroy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">destroy</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-destroy-label-Description">Description</h2>

<p>Deletes a place</p>

<h2 id="method-i-destroy-label-Resource+URL">Resource URL</h2>

<pre>/places/:id.format</pre>

<h2 id="method-i-destroy-label-Example">Example</h2>

<pre>DELETE https://backend-heypal.heroku.com/places/:id.json access_token=access_token</pre>

<h3 id="method-i-destroy-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd></dd></dl>
          

          
          <div class="method-source-code" id="destroy-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 377</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>
  <span class="ruby-identifier">place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">destroy</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:fail</span>, {<span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">format_errors</span>(<span class="ruby-identifier">place</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">messages</span>)})
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- destroy-source -->
          
        </div>

        

        
      </div><!-- destroy-method -->

    
      <div id="method-i-place_request" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">place_request</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-place_request-label-Description">Description</h2>

<p>Requests a place</p>

<h2 id="method-i-place_request-label-Resource+URL">Resource URL</h2>

<pre>/places/:id/request.format</pre>

<h2 id="method-i-place_request-label-Example">Example</h2>

<pre>GET https://backend-heypal.heroku.com/places/:id/request.json access_token=access_token</pre>

<h3 id="method-i-place_request-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd>
<p>Access token</p>
</dd><dt>check_in
<dd>
<p>Check in date</p>
</dd><dt>check_out
<dd>
<p>Check out date</p>
</dd></dl>

<h3 id="method-i-place_request-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>106
<dd>
<p>Record not found</p>
</dd><dt>137
<dd>
<p>invalid place request, check availability</p>
</dd></dl>
          

          
          <div class="method-source-code" id="place_request-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 496</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">place_request</span>
  <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-identifier">request</span> = <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">place_availability</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:check_in</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:check_out</span>], <span class="ruby-string">''</span>, <span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>[<span class="ruby-value">:err</span>].<span class="ruby-identifier">blank?</span>  
    <span class="ruby-comment"># TODO: store this elsewhere, create site settings</span>
    <span class="ruby-identifier">service_percentage</span> = <span class="ruby-value">16</span>
    <span class="ruby-identifier">service_fee</span> = <span class="ruby-identifier">request</span>[<span class="ruby-value">:sub_total</span>] * (<span class="ruby-identifier">service_percentage</span> * <span class="ruby-value">0.01</span>)
    <span class="ruby-identifier">transaction_data</span> = {
      <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>,
      <span class="ruby-value">:check_in</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:check_in</span>],
      <span class="ruby-value">:check_out</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:check_out</span>],
      <span class="ruby-value">:currency</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">request</span>[<span class="ruby-value">:currency</span>],
      <span class="ruby-value">:price_per_night</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">request</span>[<span class="ruby-value">:avg_price_per_night</span>],
      <span class="ruby-value">:price_final_cleanup</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">request</span>[<span class="ruby-value">:price_final_cleanup</span>],
      <span class="ruby-value">:price_security_deposit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">request</span>[<span class="ruby-value">:price_security_deposit</span>],
      <span class="ruby-value">:service_fee</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">service_fee</span>,
      <span class="ruby-value">:service_percentage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">service_percentage</span>,
      <span class="ruby-value">:sub_total</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">request</span>[<span class="ruby-value">:sub_total</span>]
    }
    <span class="ruby-identifier">transaction</span> = <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">transactions</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">transaction_data</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-identifier">request_return</span> = { 
        <span class="ruby-value">:transaction</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filter_fields</span>(
          <span class="ruby-identifier">transaction</span>,
          <span class="ruby-ivar">@transaction_fields</span>,
          { <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user_fields</span>} }
        ) 
      }
      <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">request!</span>
      <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, <span class="ruby-identifier">request_return</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:fail</span>, {<span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">format_errors</span>(<span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">messages</span>)})
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:fail</span>, <span class="ruby-value">:err=</span><span class="ruby-operator">&gt;</span>{<span class="ruby-value">:place</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value">137</span>]})
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- place_request-source -->
          
        </div>

        

        
      </div><!-- place_request-method -->

    
      <div id="method-i-publish" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">publish</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-publish-label-Description">Description</h2>

<p>Changes a place status</p>

<h2 id="method-i-publish-label-Resource+URL">Resource URL</h2>

<pre>/places/:id/:status.format</pre>

<h2 id="method-i-publish-label-Example">Example</h2>

<pre>GET https://backend-heypal.heroku.com/places/:id/publish.json access_token=access_token
GET https://backend-heypal.heroku.com/places/:id/unpublish.json access_token=access_token</pre>

<h3 id="method-i-publish-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd>
<p>Access token</p>
</dd><dt>status
<dd>
<p>Publish status, options: publish, unpublish</p>
</dd></dl>

<h3 id="method-i-publish-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>106
<dd>
<p>Record not found</p>
</dd><dt>123
<dd>
<p>not enough pictures</p>
</dd><dt>124
<dd>
<p>description is too short</p>
</dd><dt>126
<dd>
<p>no price</p>
</dd><dt>127
<dd>
<p>no currency</p>
</dd><dt>128
<dd>
<p>no security deposit</p>
</dd></dl>
          

          
          <div class="method-source-code" id="publish-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 426</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">publish</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:status</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;publish&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:status</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;unpublish&quot;</span>
    <span class="ruby-identifier">method</span> = <span class="ruby-node">&quot;#{params[:status]}!&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">UnknownAction</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">method</span>        
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>)
        <span class="ruby-identifier">place</span> = <span class="ruby-identifier">filter_fields</span>(<span class="ruby-ivar">@place</span>,<span class="ruby-ivar">@fields</span>, { 
          <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> {
            <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@place_type_fields</span> 
          } 
        })
        <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, {<span class="ruby-value">:place</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">place</span>})
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, { <span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">format_errors</span>(<span class="ruby-ivar">@place</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">messages</span>) })
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, { <span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:status</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value">103</span>]} } )
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- publish-source -->
          
        </div>

        

        
      </div><!-- publish-method -->

    
      <div id="method-i-search" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">search</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-search-label-Description">Description</h2>

<p>Returns a list places matching the search parameters</p>

<h2 id="method-i-search-label-Resource+URL">Resource URL</h2>

<pre>/places/search.format</pre>

<h2 id="method-i-search-label-Example">Example</h2>

<pre>GET https://backend-heypal.heroku.com/places/search.json q[country_code_eq]=AU&amp;q[num_bedrooms_lt]=5&amp;q[num_bedrooms_gt]=2&amp;page=1&amp;m=and</pre>

<h3 id="method-i-search-label-Matching+options">Matching options</h3>
<dl class="rdoc-list label-list"><dt>eq
<dd>
<p>Equal</p>

<pre>Ex: q[num_bedrooms_eq]=2</pre>
</dd><dt>not_eq
<dd>
<p>Not equal</p>

<pre>Ex: q[country_code_not_eq]=PH</pre>
</dd><dt>gt
<dd>
<p>Greater than</p>

<pre>Ex: q[num_bedrooms_gt]=4</pre>
</dd><dt>lt
<dd>
<p>Lower than</p>

<pre>Ex: q[num_bedrooms_lt]=2</pre>
</dd><dt>gteq
<dd>
<p>Greater than or equal</p>

<pre>Ex: q[num_bedrooms_gteq]=4</pre>
</dd><dt>lteq
<dd>
<p>Lower than or equal</p>

<pre>Ex: q[num_bedrooms_lteq]=4</pre>
</dd><dt>cont
<dd>
<p>Contains</p>

<pre>Ex: q[title_cont]=House</pre>
</dd><dt>true
<dd>
<p>True, 1 or 0</p>

<pre>Ex: q[amenities_washer_true]=1</pre>
</dd><dt>false
<dd>
<p>False, 1 or 0</p>

<pre>Ex: q[amenities_tv_false]=1</pre>
</dd><dt>present
<dd>
<p>Not empty, 1 or 0</p>

<pre>Ex: q[description_present]=1</pre>
</dd><dt>blank
<dd>
<p>Empty, 1 or 0</p>

<pre>Ex: q[description_present]=1</pre>
</dd></dl>

<h3 id="method-i-search-label-Parameters">Parameters</h3>

<p>The search parameters are received as an array named “q”, the paramater
itself is composed by the name of the column and the matching option. Do
not use this search paramaters for published status.</p>

<pre>Ex: q[max_guests_eq]</pre>
<dl class="rdoc-list label-list"><dt>page
<dd>
<p>Page number</p>

<pre>Ex: page=2</pre>
</dd><dt>per_page
<dd>
<p>Results per page. Default is 20</p>

<pre>Ex: per_page=10</pre>
</dd><dt>m
<dd>
<p>Used to match all the parameters or any. Options: and, or.</p>

<pre>Ex: m=or</pre>
</dd><dt>status
<dd>
<p>Defaults to published, Options: published, not_published, all</p>

<pre>Ex: status=all</pre>
</dd><dt>guests
<dd>
<p>Defaults to 1, determines the number of guests against places.max_guests</p>

<pre>Ex: guests=3</pre>
</dd><dt>currency
<dd>
<p>Defaults to USD, ISO Code of the currency the user is searching</p>

<pre>Ex: currency=USD</pre>
</dd><dt>min_price
<dd>
<p>Defaults to 0, Minimum price per night for the apartment search in the
currency selected (no cents)</p>

<pre>Ex: min_price=200</pre>
</dd><dt>max_price
<dd>
<p>Defaults to no maximum, Maximum price per night for the apartment search in
the currency selected (no cents)</p>

<pre>Ex: min_price=600</pre>
</dd><dt>sort
<dd>
<p>Sorting options: name, price_lowest, price_highest, price_size_lowest,
price_size_highest, reviews, most_recent</p>

<pre>Ex: sort=price_lowest</pre>
</dd></dl>

<h3 id="method-i-search-label-Response">Response</h3>
<dl class="rdoc-list label-list"><dt>results
<dd>
<p>Total number of results. Used for pagination</p>
</dd><dt>current_page
<dd>
<p>Current page number. Used for pagination</p>
</dd><dt>per_page
<dd>
<p>Results showed per page. Used for pagination</p>
</dd><dt>total_pages
<dd>
<p>Total number of pages. Used for pagination</p>
</dd><dt>places
<dd>
<p>Array containing the places</p>
</dd></dl>

<h3 id="method-i-search-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>115
<dd>
<p>no results</p>
</dd></dl>
          

          
          <div class="method-source-code" id="search-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">search</span>
  <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">per_page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">per_page</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">per_page</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">blank?</span>

    <span class="ruby-comment"># Currency conversion</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;USD&quot;</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:min_price</span>]
        <span class="ruby-identifier">min_price</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:min_price</span>].<span class="ruby-identifier">to_money</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>]).<span class="ruby-identifier">exchange_to</span>(<span class="ruby-value">:USD</span>).<span class="ruby-identifier">cents</span> 
        <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">merge!</span>({<span class="ruby-string">&quot;price_per_night_usd_gteq&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{min_price}&quot;</span>})
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:max_price</span>]
        <span class="ruby-identifier">max_price</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:max_price</span>].<span class="ruby-identifier">to_money</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>]).<span class="ruby-identifier">exchange_to</span>(<span class="ruby-value">:USD</span>).<span class="ruby-identifier">cents</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:max_price</span>]
        <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">merge!</span>({<span class="ruby-string">&quot;price_per_night_usd_lteq&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{max_price}&quot;</span>})
      <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># defaults to USD and checks against usd precalculated rates</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">merge!</span>({<span class="ruby-string">&quot;price_per_night_usd_gteq&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{params[:min_price]}&quot;</span>}) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:min_price</span>]
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">merge!</span>({<span class="ruby-string">&quot;price_per_night_usd_lteq&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{params[:max_price]}&quot;</span>}) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:max_price</span>]
    <span class="ruby-keyword">end</span>
    

    <span class="ruby-comment"># Filter by number of guests</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:guests</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>].<span class="ruby-identifier">merge!</span>({<span class="ruby-string">&quot;max_guests_gteq&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{params[:guests]}&quot;</span>})
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-identifier">places</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>)
    
    <span class="ruby-comment"># Filter by status</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:status</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;all&quot;</span>
      <span class="ruby-ivar">@search</span> = <span class="ruby-identifier">places</span>.<span class="ruby-identifier">search</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>])
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;published&quot;</span>
      <span class="ruby-ivar">@search</span> = <span class="ruby-identifier">places</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:published</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>).<span class="ruby-identifier">search</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>])
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;not_published&quot;</span>
      <span class="ruby-ivar">@search</span> = <span class="ruby-identifier">places</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:published</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>).<span class="ruby-identifier">search</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@search</span> = <span class="ruby-identifier">places</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:published</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>).<span class="ruby-identifier">search</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:q</span>])
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Sorting column</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;name&quot;</span>
      <span class="ruby-identifier">sorting</span> = [<span class="ruby-string">&quot;title asc&quot;</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;price_lowest&quot;</span>
      <span class="ruby-identifier">sorting</span> = [<span class="ruby-string">&quot;price_per_night_usd asc&quot;</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;price_highest&quot;</span>
      <span class="ruby-identifier">sorting</span> = [<span class="ruby-string">&quot;price_per_night_usd desc&quot;</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;price_size_lowest&quot;</span>
      <span class="ruby-identifier">sorting</span> = [<span class="ruby-string">&quot;price_sqf_usd asc&quot;</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;price_size_highest&quot;</span>
      <span class="ruby-identifier">sorting</span> = [<span class="ruby-string">&quot;price_sqf_usd desc&quot;</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;reviews_overall&quot;</span>
      <span class="ruby-identifier">sorting</span> = [<span class="ruby-string">&quot;reviews_overall desc&quot;</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;most_recent&quot;</span>
      <span class="ruby-identifier">sorting</span> = [<span class="ruby-string">&quot;updated_at desc&quot;</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">sorts</span> = <span class="ruby-identifier">sorting</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sorting</span>
    <span class="ruby-identifier">places_search</span> = <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">result</span>(<span class="ruby-value">:distinct</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">total_results</span> = <span class="ruby-identifier">places_search</span>.<span class="ruby-identifier">count</span>
    <span class="ruby-identifier">places_paginated</span> = <span class="ruby-identifier">places_search</span>.<span class="ruby-identifier">paginate</span>(<span class="ruby-value">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>], <span class="ruby-value">:per_page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">per_page</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">places_paginated</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">filtered_places</span> = <span class="ruby-identifier">filter_fields</span>(<span class="ruby-identifier">places_paginated</span>, <span class="ruby-ivar">@search_fields</span>, { <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> { 
        <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user_fields</span>,
        <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@place_type_fields</span> },
      <span class="ruby-value">:currency</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>]
      })

      <span class="ruby-identifier">place_types</span> = <span class="ruby-constant">PlaceType</span>.<span class="ruby-identifier">all_cached</span>

      <span class="ruby-identifier">place_type_count</span> = {}
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">place_type</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">place_types</span>
        <span class="ruby-identifier">count</span> = <span class="ruby-value">0</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">place</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">places_paginated</span>
          <span class="ruby-identifier">count</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">place_type_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">place_type</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">place_type_count</span>.<span class="ruby-identifier">merge!</span>({<span class="ruby-identifier">place_type</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">parameterize</span>(<span class="ruby-identifier">sep</span> = <span class="ruby-string">'_'</span>).<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">count</span>}) 
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">amenities_count</span> = {}
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">amenity</span> <span class="ruby-keyword">in</span> <span class="ruby-ivar">@amenities</span>
        <span class="ruby-identifier">count</span> = <span class="ruby-value">0</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">place</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">places_paginated</span>
          <span class="ruby-identifier">count</span><span class="ruby-operator">+=</span><span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">place</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">amenity</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">amenities_count</span>.<span class="ruby-identifier">merge!</span>({<span class="ruby-identifier">amenity</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;amenities_&quot;</span>, <span class="ruby-string">&quot;&quot;</span>) =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">count</span>}) 
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">response</span> = {
        <span class="ruby-value">:places</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filtered_places</span>, 
        <span class="ruby-value">:results</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">total_results</span>, 
        <span class="ruby-value">:per_page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">per_page</span>, 
        <span class="ruby-value">:current_page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>], 
        <span class="ruby-value">:place_type_count</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">place_type_count</span>,
        <span class="ruby-value">:amenities_count</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">amenities_count</span>,
        <span class="ruby-value">:total_pages</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">total_results</span><span class="ruby-operator">/</span><span class="ruby-identifier">per_page</span>.<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">ceil</span>
      }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">response</span> = {<span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:places</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value">115</span>]}}
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, <span class="ruby-identifier">response</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, {<span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:query</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value">101</span>]}})
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div><!-- search-source -->
          
        </div>

        

        
      </div><!-- search-method -->

    
      <div id="method-i-show" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">show</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-show-label-Description">Description</h2>

<p>Returns all the information about a place</p>

<h2 id="method-i-show-label-Resource+URL">Resource URL</h2>

<pre>/places/:id.format</pre>

<h2 id="method-i-show-label-Example">Example</h2>

<pre>GET https://backend-heypal.heroku.com/places/id.json</pre>

<h3 id="method-i-show-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>id
<dd>
<p>if of the place</p>
</dd><dt>currency
<dd>
<p>ISO Code of the currency to return prices in</p>
</dd></dl>
          

          
          <div class="method-source-code" id="show-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 255</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
  <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-identifier">place</span> = <span class="ruby-identifier">filter_fields</span>(<span class="ruby-ivar">@place</span>, <span class="ruby-ivar">@fields</span>, { <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> { 
    <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user_fields</span>,
    <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@place_type_fields</span> },
  <span class="ruby-value">:currency</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:currency</span>]})
  <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, {<span class="ruby-value">:place</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">place</span>})
<span class="ruby-keyword">end</span></pre>
          </div><!-- show-source -->
          
        </div>

        

        
      </div><!-- show-method -->

    
      <div id="method-i-transactions" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">transactions</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-transactions-label-Description">Description</h2>

<p>Requests a place</p>

<h2 id="method-i-transactions-label-Resource+URL">Resource URL</h2>

<pre>/places/:id/transactions.format</pre>

<h2 id="method-i-transactions-label-Example">Example</h2>

<pre>GET https://backend-heypal.heroku.com/places/:id/transactions.json access_token=access_token&amp;status=active</pre>

<h3 id="method-i-transactions-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd>
<p>Access token</p>
</dd><dt>status
<dd>
<p>Options: active, inactive, any, Defaults to active</p>
</dd></dl>

<h3 id="method-i-transactions-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>106
<dd>
<p>Record not found</p>
</dd><dt>115
<dd>
<p>no results</p>
</dd></dl>
          

          
          <div class="method-source-code" id="transactions-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 546</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">transactions</span>
  <span class="ruby-identifier">place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:manage</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:status</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;active&quot;</span>
    <span class="ruby-identifier">transactions</span> = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">transactions</span>.<span class="ruby-identifier">active</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;inactive&quot;</span>
    <span class="ruby-identifier">transactions</span> = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">transactions</span>.<span class="ruby-identifier">inactive</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;any&quot;</span>
    <span class="ruby-identifier">transactions</span> = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">transactions</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">transactions</span> = <span class="ruby-identifier">place</span>.<span class="ruby-identifier">transactions</span>.<span class="ruby-identifier">active</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">transactions</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">transactions_return</span> = { 
      <span class="ruby-value">:transactions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filter_fields</span>(
        <span class="ruby-identifier">transactions</span>,
        <span class="ruby-ivar">@transaction_fields</span>, { <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user_fields</span>} }
      ) 
    }
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, <span class="ruby-identifier">transactions_return</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, {<span class="ruby-value">:err=</span><span class="ruby-operator">&gt;</span>{<span class="ruby-value">:transactions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value">115</span>]}} )
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- transactions-source -->
          
        </div>

        

        
      </div><!-- transactions-method -->

    
      <div id="method-i-update" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-update-label-Description">Description</h2>

<p>Updates a place with additional information</p>

<h2 id="method-i-update-label-Resource+URL">Resource URL</h2>

<pre>/places/:id.format</pre>

<h2 id="method-i-update-label-Example">Example</h2>

<pre>PUT https://backend-heypal.heroku.com/places/1.json access_token=access_token&amp;num_beds=5&amp;description=Nam luctus feugiat</pre>

<h3 id="method-i-update-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd>
<p>Access token</p>
</dd><dt>title
<dd>
<p>String,  title of the place</p>
</dd><dt>description
<dd>
<p>Text,    long description of the place</p>
</dd><dt>place_type_id
<dd>
<p>Integer, ID from the PlaceType model</p>
</dd><dt>num_bedrooms
<dd>
<p>Integer, number of bedrooms</p>
</dd><dt>num_beds
<dd>
<p>Integer, number of beds</p>
</dd><dt>num_bathrooms
<dd>
<p>Integer, number of bathrooms</p>
</dd><dt>size
<dd>
<p>Float,  square meters or square feet of the entire place</p>
</dd><dt>size_unit
<dd>
<p>String,  Size unit, feet or meters</p>
</dd><dt>max_guests
<dd>
<p>Integer, maximum number of guests the place can fit</p>
</dd><dt>city_id
<dd>
<p>Integer, ID from the Cities model</p>
</dd><dt>address_1
<dd>
<p>String,  text description of address</p>
</dd><dt>address_2
<dd>
<p>String</p>
</dd><dt>zip
<dd>
<p>String,  postal code</p>
</dd><dt>lat
<dd>
<p>Double,  latitude coordinates</p>
</dd><dt>lon
<dd>
<p>Double,  longitude coordinates</p>
</dd><dt>directions
<dd>
<p>Text,    description on how to find the place</p>
</dd><dt>amenities_name
<dd>
<p>The following options are accepted (replace “name”).
aircon,breakfast,buzzer_intercom,cable_tv,dryer,doorman,elevator,
family_friendly,gym,hot_tub,kitchen,handicap,heating,hot_water,
internet,internet_wifi,jacuzzi,parking_included,pets_allowed,pool,
smoking_allowed,suitable_events,tennis,tv,washer</p>
</dd><dt>currency
<dd>
<p>Currency ISO code, Ex. USD</p>
</dd><dt>price_per_night
<dd>
<p>Currency Units, not cents 1=$1, Integer</p>
</dd><dt>price_per_week
<dd>
<p>Currency Units, not cents 1=$1, Integer</p>
</dd><dt>price_per_month
<dd>
<p>Currency Units, not cents 1=$1, Integer</p>
</dd><dt>price_final_cleanup
<dd>
<p>Currency Units, not cents 1=$1, Integer</p>
</dd><dt>price_security_deposit
<dd>
<p>Currency Units, not cents 1=$1, Integer</p>
</dd><dt>check_in_after
<dd>
<p>String, ie. 11:00 / 11:30 / 13:30</p>
</dd><dt>check_out_before
<dd>
<p>String, ie. 11:00 / 11:30 / 13:30</p>
</dd><dt>minimum_stay_days
<dd>
<p>Integer, 0 means no minimum</p>
</dd><dt>maximum_stay_days
<dd>
<p>Integer, 0 means no maximum</p>
</dd><dt>house_rules
<dd>
<p>Text, rules for the user to follow when staying at a place</p>
</dd><dt>cancellation_policy
<dd>
<p>Integer. Should align with frontend, 1=flexible, 2=moderate, 3=strict</p>
</dd></dl>

<h3 id="method-i-update-label-Response">Response</h3>
<dl class="rdoc-list label-list"><dt>place
<dd>
<p>Array containing the recently created place</p>
</dd></dl>

<h3 id="method-i-update-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>101
<dd>
<p>can’t be blank</p>
</dd><dt>103
<dd>
<p>is invalid</p>
</dd><dt>105
<dd>
<p>invalid access token</p>
</dd><dt>118
<dd>
<p>must be a number</p>
</dd></dl>
          

          
          <div class="method-source-code" id="update-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 356</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>
  <span class="ruby-ivar">@place</span> = <span class="ruby-constant">Place</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-identifier">place</span> = <span class="ruby-identifier">filter_params</span>(<span class="ruby-identifier">params</span>, <span class="ruby-ivar">@fields</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@place</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">place</span>)
    <span class="ruby-identifier">place_return</span> = <span class="ruby-identifier">filter_fields</span>(<span class="ruby-ivar">@place</span>,<span class="ruby-ivar">@fields</span>, { <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> {
      <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user_fields</span>,
      <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@place_type_fields</span> } })
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, {<span class="ruby-value">:place</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">place_return</span>})
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:fail</span>, {<span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">format_errors</span>(<span class="ruby-ivar">@place</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">messages</span>)})
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update-source -->
          
        </div>

        

        
      </div><!-- update-method -->

    
      <div id="method-i-user_places" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">user_places</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <h2 id="method-i-user_places-label-Description">Description</h2>

<p>Shows a users places</p>

<h2 id="method-i-user_places-label-Resource+URL">Resource URL</h2>

<pre>/users/:id/places.format</pre>

<h2 id="method-i-user_places-label-Example">Example</h2>

<pre>GET https://backend-heypal.heroku.com/users/:id/places.json access_token=access_token&amp;published=0</pre>

<h3 id="method-i-user_places-label-Parameters">Parameters</h3>
<dl class="rdoc-list label-list"><dt>access_token
<dd>
<p>Access token</p>
</dd><dt>published
<dd>
<p>Shows or hides unpublished places (shows published places by default),
Boolean value</p>
</dd></dl>

<h3 id="method-i-user_places-label-Error+codes">Error codes</h3>
<dl class="rdoc-list label-list"><dt>115
<dd>
<p>no results</p>
</dd></dl>
          

          
          <div class="method-source-code" id="user_places-source">
            <pre><span class="ruby-comment"># File app/controllers/places_controller.rb, line 397</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">user_places</span>
  <span class="ruby-ivar">@places</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">places</span>.<span class="ruby-identifier">with_permissions_to</span>(<span class="ruby-value">:read</span>)
  <span class="ruby-ivar">@places</span> = <span class="ruby-ivar">@places</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:published</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:published</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;0&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@places</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">places_return</span> = <span class="ruby-identifier">filter_fields</span>(<span class="ruby-ivar">@places</span>,<span class="ruby-ivar">@fields</span>, { <span class="ruby-value">:additional_fields</span> =<span class="ruby-operator">&gt;</span> {
      <span class="ruby-value">:place_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@place_type_fields</span>}})
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, {<span class="ruby-value">:places</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">places_return</span>})
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">return_message</span>(<span class="ruby-value">200</span>, <span class="ruby-value">:ok</span>, { <span class="ruby-value">:err</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:places</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value">115</span>]}})
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- user_places-source -->
          
        </div>

        

        
      </div><!-- user_places-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.11.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

